{{- $redisHost := "" }}
{{- $redisPort := "" }}
{{- $redisPassword := "" }}
{{- $externalRedis := .Values.redis.external }}
{{- $db_type := printf "pdo_%s" (.Values.db.type | default "mysql") | toString | b64enc }}
{{- $db_name := .Values.db.name | toString | b64enc }}
{{- $db_user := .Values.db.user | toString | b64enc }}
{{- $db_password := .Values.db.password | toString | b64enc }}
{{- $db_host := .Values.db.host | toString | b64enc }}
{{- $db_port := .Values.db.port | default "3306" | toString | b64enc }}
{{- $name := .Values.wallabag.name | default "Wallabag" | toString }}
{{- $mailHost := .Values.mail.smtp.host | default "smtp.gmail.com" | toString }}
{{- $mailPort := .Values.mail.smtp.port | default "465" | toString }}
{{- $mailUser := .Values.mail.smtp.user | toString }}
{{- $mailPassword := .Values.mail.smtp.password | toString }}
{{- $mail2fa := .Values.mail.2fa_email | toString | b64enc }}
{{- $mailFrom := .Values.mail.from_email | default (printf "%s <%s>" $name $mailUser) | toString | b64enc }}
{{- if $externalRedis }}
  {{- $redisHost = .Values.redis.host | toString | b64enc }}
  {{- $redisPort = .Values.redis.port | default "6379" | toString | b64enc }}
  {{- $redisPassword = .Values.redis.password | toString | b64enc }}
{{- else }}
  {{- $redisHost = "localhost" | toString | b64enc }}
  {{- $redisPort = .Values.service.redis.port | default "6379" | toString | b64enc }}
{{- end }}
{{- $secret := .Values.wallabag.secret | toString | b64enc }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-wallabag-secret
  labels:
    {{- include "wallabag.labels" . | nindent 4 }}
type: Opaque
data:
  DATABASE_CHARSET: {{ "utf8mb4" | toString | b64enc }}
  DATABASE_TABLE_PREFIX: {{ "wallabag_" | toString | b64enc }}
  DATABASE_DRIVER: {{ $db_type }}
  DATABASE_NAME: {{ $db_name }}
  DATABASE_USER: {{ $db_user }}
  DATABASE_PASSWORD: {{ $db_password }}
  DATABASE_HOST: {{ $db_host }}
  DATABASE_PORT: {{ $db_port }}
  MAILER_DSN: {{ "smtp://%s:%s@%s:%s" $mailUser $mailPassword $mailHost $mailPort | toString | b64enc }}
  FROM_EMAIL: {{ $mailFrom }}
  TWOFACTOR_SENDER: {{ $mail2fa }}
  SECRET: {{ $secret }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-wallabag-redis-secret
  labels:
    {{- include "wallabag.labels" . | nindent 4 }}
type: Opaque
data:
  REDIS_HOST: {{ $redisHost }}
  REDIS_PORT: {{ $redisPort }}
  {{- if and $externalRedis $redisPassword }}
  REDIS_PASSWORD: {{ $redisPassword }}
  {{- end }}
  # REDIS_DB: ""
